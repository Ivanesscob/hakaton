<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель</title>
    <link rel="stylesheet" href="/static/stylePanel.css">
</head>
<body background-color="black">
<div class="sidebar-toggle" id="sidebar-toggle">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
</div>

<div class="sidebar" id="sidebar">
    <h3>Меню</h3>
    <div class="sidebar-text">
        <p>Добро пожаловать в панель управления!</p>
        <p>Здесь вы можете управлять своими бизнесами и продуктами.</p>
        <p>Для выхода из системы нажмите кнопку ниже.</p>
    </div>
    <button class="logout-btn" id="logout-btn">Выйти</button>
</div>

<div class="container">
    <div class="scene" id="scene-container">
        <!-- Блоки будут добавлены динамически -->
    </div>
    <div class="list" id="list-container">
        <!-- Блоки списка будут добавлены динамически -->
    </div>
    <div class="info-panel" id="info-panel">Выберите бизнес для просмотра информации</div>
</div>

<script>
    // Функция для проверки авторизации
    function checkAuth() {
        const companyData = localStorage.getItem('companyData');
        return companyData !== null;
    }
    
    // Функция для выхода из системы
    function logout() {
        localStorage.removeItem('companyData');
        window.location.href = '/auth/login';
    }
    
    // Функция для загрузки данных о компании и бизнесах
    function loadCompanyData() {
        if (!checkAuth()) {
            window.location.href = '/auth/login';
            return;
        }
        
        const companyData = JSON.parse(localStorage.getItem('companyData'));
        
        if (!companyData || companyData.status !== 'success') {
            console.error('Данные компании не найдены или неверный формат');
            window.location.href = '/auth/login';
            return;
        }
        
        const businesses = companyData.businesses || [];
        const sceneContainer = document.getElementById('scene-container');
        const listContainer = document.getElementById('list-container');
        
        // Очищаем контейнеры
        sceneContainer.innerHTML = '';
        listContainer.innerHTML = '';
        
        // Создаем блоки для каждого бизнеса
        businesses.forEach((business, index) => {
            // Создаем блок в сцене
            const sceneBox = document.createElement('div');
            sceneBox.className = 'scene-box';
            sceneBox.textContent = business.name;
            sceneBox.dataset.businessId = business._id;
            sceneBox.addEventListener('click', () => showBusinessInfo(business));
            sceneContainer.appendChild(sceneBox);
            
            // Создаем элемент в списке
            const listItem = document.createElement('div');
            listItem.className = 'list-box';
            listItem.textContent = business.name;
            listItem.dataset.businessId = business._id;
            
            // Создаем контейнер для продуктов
            const productsContainer = document.createElement('div');
            productsContainer.className = 'products-tree';
            productsContainer.style.display = 'none';
            
            // Добавляем продукты в дерево
            if (business.products && business.products.length > 0) {
                const productsList = document.createElement('ul');
                business.products.forEach(product => {
                    const productItem = document.createElement('li');
                    productItem.textContent = `${product.name} - ${product.price} руб.`;
                    productsList.appendChild(productItem);
                });
                productsContainer.appendChild(productsList);
            } else {
                productsContainer.innerHTML = '<p>Нет продуктов</p>';
            }
            
            // Добавляем обработчик клика для раскрытия дерева продуктов
            listItem.addEventListener('click', () => {
                // Проверяем, открыто ли уже дерево продуктов для этого бизнеса
                const isTreeVisible = productsContainer.style.display === 'block';
                
                // Скрываем все деревья продуктов
                document.querySelectorAll('.products-tree').forEach(tree => {
                    tree.style.display = 'none';
                });
                
                // Если дерево было скрыто, показываем его, иначе оставляем скрытым
                if (!isTreeVisible) {
                    productsContainer.style.display = 'block';
                    // Показываем информацию о бизнесе
                    showBusinessInfo(business);
                }
            });
            
            // Добавляем элементы в список
            listContainer.appendChild(listItem);
            listContainer.appendChild(productsContainer);
        });
        
        // Добавляем блок-кнопку для создания нового бизнеса
        const addBusinessBox = document.createElement('div');
        addBusinessBox.className = 'scene-box add-business';
        addBusinessBox.innerHTML = '<div class="add-icon">+</div><div class="add-text">Добавить бизнес</div>';
        addBusinessBox.addEventListener('click', () => {
            alert('Функция добавления нового бизнеса будет доступна в следующем обновлении');
        });
        sceneContainer.appendChild(addBusinessBox);
    }
    
    // Функция для отображения информации о бизнесе
    function showBusinessInfo(business) {
        const infoPanel = document.getElementById('info-panel');
        
        let productsHtml = '';
        if (business.products && business.products.length > 0) {
            productsHtml = '<h3>Продукты:</h3><ul>';
            business.products.forEach(product => {
                productsHtml += `<li>${product.name} - ${product.price} руб.</li>`;
            });
            productsHtml += '</ul>';
        }
        
        infoPanel.innerHTML = `
            <h2>${business.name}</h2>
            <p>${business.description}</p>
            ${productsHtml}
        `;
    }
    
    // Функция для переключения боковой панели
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        
        sidebar.classList.toggle('open');
        sidebarToggle.classList.toggle('open');
        
        // Изменяем направление стрелки
        const svg = sidebarToggle.querySelector('svg');
        if (sidebar.classList.contains('open')) {
            svg.innerHTML = '<polyline points="15 18 9 12 15 6"></polyline>';
        } else {
            svg.innerHTML = '<polyline points="9 18 15 12 9 6"></polyline>';
        }
    }
    
    // Загружаем данные при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadCompanyData();
        
        // Добавляем обработчики событий для боковой панели
        document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
        document.getElementById('logout-btn').addEventListener('click', logout);
    });
</script>
</body>
</html>